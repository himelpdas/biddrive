<!-- winning certificate -->
{{extend 'page_layout.html'}}

<div id="certificate">
	<div class="row">
		<div class="col-xs-1">
			<a href="#" onClick="window.print()">
				<h1 class="hidden-print"><i class="fa fa-print fa-fw text-success"></i></h1>{{#how to print in bootstrap http://goo.gl/xm88V}}
				<h1 class="visible-print"><i class="fa fa-car fa-fw"></i></h1>
			</a>
		</div>

		<div class="col-xs-3">
			<h3>BidDrive.com</h3>
		</div>

		<div class="col-xs-4" style="text-align:center;">
			<h4><u>{{=year}} {{=make.upper()}} {{=model.upper()}}</u></h4>
			<h5 class="text-light"><u>{{=trim}}</u></h5>
		</div>

		<div class="col-xs-4">
			<img src="https://api.qrserver.com/v1/create-qr-code/?size=75x75&data={{=winner_code_spaced}}" alt="Winning QR Code" class="fa-rotate-90 img-responsive pull-right">
		</div>
	</div>
	<hr>
	<div class="row">

		<div class="col-xs-5">
			<div class = "row">
				<img src="{{=map_url}}" alt="Dealer Map" class="img-responsive">
			</div>
			<hr>
			{{for i, each_image_url in enumerate(image_urls):}}
				{{new_row=False if (i%2) else True}}
				{{if new_row:}}
					<div class="row">
				{{pass}}
						<div class="col-xs-6" style="padding-bottom:18px;">
							<img src="{{=image_urls[each_image_url]}}" alt="{{=each_image_url}}" class="img-responsive">
						</div>
				{{if not new_row:}}
					</div>
				{{pass}}
			{{pass}}
				{{if len(image_urls)%2:}} {{#make sure div closes if there are an odd number of images}}
					</{{="div"}}>
				{{pass}}
				{{if not len(image_urls):}} {{#if there are no images show generic image}}
					<div class="row">
						<div class="col-xs-6">
							<img src="http://placehold.it/500x400&text=No image" class="img-responsive">
						</div>
					</div>
				{{pass}}
		</div>

		<div class="col-xs-7">
			<table class="table table-hover">
				<tr>
					<th  style="border-top: none">Auction ID:</th>
					<td  style="border-top: none">{{=str(auction_request_id).zfill(3)}}</td>
				</tr>
				
				<tr>
					<th>VIN #:</th>
					<td>{{=vin}}</td>
				</tr>

				<tr>
					<th>Price lock:</th>
					<td>{{=last_bid_price}}</td>
				</tr>			
				
			{{if is_lease:}}
				<tr>
					<th>Lease term:</th>
					<td>{{=auction_request.lease_term}} or {{auction_request.lease_mileage}}</td>
				</tr>
			{{pass}}
			
				<tr>
					<th>Color:</th>
					<td>{{=color}}</td>
				</tr>

				<tr>
					<th>Options:</th>
					<td>
						{{for each_option in option_names:}}
							<div><i class="fa fa-shield fa-rotate-270"></i>&nbsp;&nbsp;&nbsp;{{=each_option}}</div>
						{{pass}}
					</td>
				</tr>            
				
				<tr>
					<th>Dealer:</th>
					<td>
						<div><strong>{{='%s %s' % (dealer.first_name, dealer.last_name)}}</strong></div>
						<div class="hidden-print"><a href="mailto:{{=dealer.email}}?subject=Regarding {{=APP_NAME}} auction {{=str(auction_request_id).zfill(3)}} ({{=year}} {{=make.upper()}} {{=model.upper()}})&body=Hello {{=dealer.first_name.capitalize()}}! You are the winner of my request (ID {{=str(auction_request_id).zfill(3)}}) for a {{=year}} {{=make.upper()}} {{=model.upper()}}. Please reply as soon as possible! -{{=auth.user.first_name.capitalize()}}">{{=dealer.email}}</a></div> {{#since only requester can view its safe to use auth.user}}
						<div class="visible-print">{{=dealer.email}}</div>
					</td>
				</tr>

				<tr>
					<th>Dealership:</th>
					<td>
						<div><strong>{{=dealership.dealership_name}}</strong></div>
						<div>{{=dealership.address_line_1}}</div>
						<div>{{=dealership.address_line_2}}</div>
						<div>{{=dealership.city}}, {{=dealership.state}}, {{=dealership.zip_code}}</div>
						<div>{{=dealership.country}}</div>
						<div>{{=dealership.phone}}</div>
					</td>
				</tr>

				<tr>
					<th>Please bring your:</th>
					<td>
						<div><i class="fa fa-shield fa-rotate-270"></i>&nbsp;&nbsp;&nbsp;<a href="#" onClick="window.print()">Certificate</a></div>
						<div><i class="fa fa-shield fa-rotate-270"></i>&nbsp;&nbsp;&nbsp;Driver's license</div>
						<div><i class="fa fa-shield fa-rotate-270"></i>&nbsp;&nbsp;&nbsp;Registration and insurance</div>
						<div><i class="fa fa-shield fa-rotate-270"></i>&nbsp;&nbsp;&nbsp;Credit card bill or bank statement</div>
						{{if trade_in:}}<div><i class="fa fa-shield fa-rotate-270"></i>&nbsp;&nbsp;&nbsp;Current trade-in vehicle and title</div>{{pass}}
					</td>
				</tr>            

			</table>
		</div>
	</div>
</div>

{{if not contact_made:}}
<div id="myModal" class="modal fade">
  <br>
  <br>
  <br>
  <br>
  <div class="modal-dialog">
    <div class="modal-content" style="background-color:rgba(246,246,246,0.8);">
      <div class="modal-header">
        {{#<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>}}
        <h4 class="modal-title"><i class="fa fa-check-circle-o fa-fw text-success"></i> Validation</h4>
      </div>
      <div class="modal-body">
        <div style="text-align:center;">
			<h3>Call us at <span class="text-info"><i class="fa fa-fw fa-phone"></i>{{=TWILIO_NUMBER}}</span> to reveal your {{=APP_NAME}} certificate of guarantee.</h3>
			<button id="refresh_certificate" type="button" class="btn btn-default btn-lg">
				<span class="glyphicon glyphicon-refresh"></span> Refresh
			</button>
			<script type="text/javascript">
				$('#refresh_certificate').click(function() {
					location.reload();
				});
			</script>
		</div>
	  </div>
      <div class="modal-footer">
        <div class="text-danger" style="font-size: 21px; text-align:center;">Winner code: <strong>{{=winner_code_spaced}}</strong> (write it down)</div>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<script type="text/javascript">
	$('#myModal').modal({backdrop:'static',keyboard:false, show:true}); {{#http://goo.gl/HAohdA}}
	$('#certificate').css({
		'-webkit-filter': 'blur(5px)',
		'-moz-filter': 'blur(5px)',
		'-o-filter': 'blur(5px)',
		'-ms-filter': 'blur(5px)',
		'filter': 'blur(5px)',
	});
    $('.modal').modal('show');
</script>
{{"""}}
<script>{{#polling to see whether connection was made #http://goo.gl/17YuW}}
(function poll(){
	$.ajax({ url: "{{=URL('init', 'ajax', 'contact_made.json', args=[winner_code])}}{{#TODO hmac enforce}}", success: function(data){
        //Update your dashboard gauge
        if (data.status=="success"){
			$('#refresh_certificate').click(function() {
				location.reload();
			});
		}
    }, dataType: "json", complete: poll, timeout: 7777 });
})(); {{#self executing func #http://goo.gl/2fJHT}}
</script>
{{"""}}
<script>{{#polling to see whether connection was made #http://goo.gl/17YuW}}
setInterval(function(){
	$.ajax({ url: "{{=URL('init', 'ajax', 'contact_made.json', args=[winner_code])}}{{#TODO hmac enforce}}", success: function(data){
        //Update your dashboard gauge
        if (data['status']=="success"){
			location.reload();
		}
    }, dataType: "json"});
}, 5000); {{#self executing func #http://goo.gl/2fJHT}}
</script>
{{pass}}